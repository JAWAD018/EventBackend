<script>
  const userForm = document.getElementById('userForm');
  const userList = document.getElementById('userList');

  // API URL
  const API_BASE_URL = 'https://event-backend-4woe.onrender.com/api';

  // Submit Form Handler
  userForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData();
    formData.append('qrCode', document.getElementById('qrCode').value);
    formData.append('name', document.getElementById('name').value);
    formData.append('email', document.getElementById('email').value);
    formData.append('gender', document.getElementById('gender').value);
    formData.append('group', document.getElementById('group').value);
    formData.append('photo', document.getElementById('photo').files[0]);

    try {
      const response = await fetch(`${API_BASE_URL}/users`, {
        method: 'POST',
        body: formData,
      });
      const result = await response.json();
      if (result.success) {
        alert('User registered successfully!');
        fetchUsers(); // Refresh user list
      } else {
        alert(result.message);
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error registering user.');
    }
  });

  // Fetch Registered Users
  async function fetchUsers() {
    try {
      const response = await fetch(`${API_BASE_URL}/users`);
      const result = await response.json();

      if (result.success) {
        displayUsers(result.users);
      } else {
        alert('Error fetching users.');
      }
    } catch (error) {
      console.error('Error:', error);
    }
  }

  // Display Users in the List
  function displayUsers(users) {
    userList.innerHTML = '<h2>Registered Users</h2>';
    users.forEach(user => {
      const userDiv = document.createElement('div');
      userDiv.classList.add('user');
      userDiv.innerHTML = `
        <img src="${user.photo}" style="width: 200px; height: 200px; object-fit: cover; border-radius: 50%; margin: 0 auto 15px;" alt="User Photo">
        <p><strong>Name:</strong> ${user.name}</p>
        <p><strong>Email:</strong> ${user.email}</p>
        <p><strong>Gender:</strong> ${user.gender || 'N/A'}</p>
        <p><strong>Group:</strong> ${user.group || 'N/A'}</p>
        <div class="qr-code">
          <img src="${user.qrCodeImage}" alt="QR Code">
          <a href="${user.qrCodeImage}" download="qr-code-${user.name}.png">
            <button>Download QR Code</button>
          </a>
        </div>
        <button class="delete-btn" onclick="deleteUser('${user.qrCode}')">Delete</button>
      `;
      userList.appendChild(userDiv);
    });
  }

  // Delete user by QR Code
  async function deleteUser(qrCode) {
    try {
      const response = await fetch(`${API_BASE_URL}/users/${qrCode}`, {
        method: 'DELETE',
      });
      const result = await response.json();
      if (result.success) {
        alert('User deleted successfully!');
        fetchUsers(); // Refresh user list
      } else {
        alert('Error deleting user.');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error deleting user.');
    }
  }

  // Initial Fetch
  fetchUsers();
</script>
